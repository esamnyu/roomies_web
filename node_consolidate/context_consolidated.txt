// Consolidated 1 files from the "context" folder
// This file contains all code files within the "context" folder and its subfolders.

// Directory: context, File: AuthContext.tsx
// File Type: tsx
```tsx
// src/context/AuthContext.tsx
'use client';

import React, { createContext, useContext, useEffect, useState, ReactNode } from 'react';
import { supabaseClient } from '@/lib/supabase'; // Ensure this path is correct
import { useRouter } from 'next/navigation';
import { Session, User as SupabaseAuthUser, AuthChangeEvent, AuthSession } from '@supabase/supabase-js'; // Rename imported User

// Define YOUR custom UserProfile type (align with your public 'User' table)
// You might want to move this to a shared types file (e.g., src/types/index.ts)
type UserProfile = {
  id: string;
  email: string | null; // Email might be null? Adjust if always present
  name: string | null; // Name might be null? Adjust if always present
  avatar?: string | null;
  // Add other fields from your 'User' table if you need them globally
};

// Define the shape of the context using YOUR UserProfile type
type AuthContextType = {
  user: UserProfile | null; // Use your UserProfile type here
  session: Session | null;
  isLoading: boolean;
  signIn: (email: string, password: string) => Promise<{ error: any }>;
  signUp: (email: string, password: string, name: string) => Promise<{ error: any, data: any }>;
  signOut: () => Promise<void>;
};

// Create the context
const AuthContext = createContext<AuthContextType | undefined>(undefined);

interface AuthProviderProps {
  children: ReactNode;
}

export function AuthProvider({ children }: AuthProviderProps) {
  const [user, setUser] = useState<UserProfile | null>(null); // Use UserProfile type
  const [session, setSession] = useState<Session | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const router = useRouter();

  // Function to fetch profile data from your public User table
  const fetchUserProfile = async (authUserId: string): Promise<UserProfile | null> => {
    try {
      console.log(`AuthProvider: Fetching profile for user ID: ${authUserId}`);
      const { data: profileData, error: profileError } = await supabaseClient
        .from('User') // Your public User table name
        .select('id, name, email, avatar') // Select the fields you need
        .eq('id', authUserId)
        .single(); // Expect only one profile per auth ID

      if (profileError) {
        console.error('AuthProvider: Error fetching user profile:', profileError.message);
        // Handle case where profile might not exist yet after sign up, before API call completes?
        if (profileError.code === 'PGRST116') { // 'PGRST116' is typically "No rows found"
             console.warn(`AuthProvider: No profile found in DB for user ${authUserId}. This might be okay right after signup.`);
             return null; // Return null if profile not found
        }
        return null; // Return null on other errors too, maybe logout?
      }

      if (profileData) {
          console.log(`AuthProvider: Profile fetched successfully for ${authUserId}`);
          return profileData as UserProfile;
      }
      return null;

    } catch (err) {
      console.error('AuthProvider: Unexpected error fetching profile:', err);
      return null;
    }
  };


  useEffect(() => {
    let isMounted = true;

    const handleAuthStateChange = async (event: AuthChangeEvent, session: AuthSession | null) => {
        console.log('AuthProvider: Auth state changed:', event);
        if (!isMounted) return; // Prevent updates if unmounted

        setSession(session);
        const authUser = session?.user ?? null;

        if (authUser) {
            console.log('AuthProvider: Session exists, user ID:', authUser.id);
            // Fetch the profile data from your DB based on the Supabase Auth user ID
            const profile = await fetchUserProfile(authUser.id);
            if (isMounted) {
                setUser(profile); // Set user state to the fetched profile
                setIsLoading(false); // Stop loading once profile (or null) is set
            }
        } else {
            console.log('AuthProvider: Session is null.');
            if (isMounted) {
                setUser(null); // Clear user profile
                setIsLoading(false); // Stop loading
                // Optional: Redirect on sign out event here if preferred
                // if (event === 'SIGNED_OUT') { router.push('/login'); }
            }
        }
    };

    // --- Initial Session Check ---
    const getInitialSession = async () => {
        try {
            console.log('AuthProvider: Getting initial session...');
            const { data: { session: initialSession }, error } = await supabaseClient.auth.getSession();
            if (error) {
                console.error('AuthProvider: Error getting initial session:', error.message);
            }
            // Trigger the handler manually for the initial state
            await handleAuthStateChange('INITIAL_SESSION', initialSession);
        } catch (err) {
             console.error('AuthProvider: Unexpected error in getInitialSession:', err);
             if (isMounted) {
                 setUser(null);
                 setSession(null);
                 setIsLoading(false);
             }
        }
    };
    getInitialSession();
    // --- End Initial Session Check ---


    // Set up the listener for subsequent auth state changes
    const { data: { subscription } } = supabaseClient.auth.onAuthStateChange(handleAuthStateChange);

    // Cleanup function
    return () => {
      isMounted = false;
      subscription?.unsubscribe();
    };
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []); // Removed router dependency as it's stable from next/navigation

  // --- Sign In, Sign Up, Sign Out methods remain largely the same ---
  // They trigger Supabase Auth, which then triggers onAuthStateChange above.

  const signIn = async (email: string, password: string) => {
    console.log('AuthProvider: Signing in with email:', email);
    // No need to setIsLoading(true) here, onAuthStateChange handles loading state
    try {
      const { error } = await supabaseClient.auth.signInWithPassword({
        email,
        password
      });
      if (error) console.error('AuthProvider: Sign in error:', error);
      // State update will happen via onAuthStateChange
      return { error };
    } catch (err) {
      console.error('AuthProvider: Unexpected error during sign in:', err);
      return { error: err };
    }
  };

  const signUp = async (email: string, password: string, name: string) => {
    // No need to setIsLoading(true) here
    try {
      console.log('AuthProvider: Signing up with email:', email);
      const { data: signUpData, error: signUpError } = await supabaseClient.auth.signUp({
        email,
        password,
        options: {
          data: { name },
          emailRedirectTo: `${window.location.origin}/auth/callback`,
        }
      });

      if (signUpError) {
        console.error('AuthProvider: Sign up error:', signUpError);
        return { data: null, error: signUpError };
      }

      if (signUpData.user) {
        console.log('AuthProvider: Supabase Auth user created/exists. Calling /api/users to ensure profile...');
        try {
          // Ensure the profile exists in your public table
          // Note: Consider using Supabase DB Triggers/Functions for this in production
          const response = await fetch('/api/users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: signUpData.user.id, email, name }),
          });
          if (!response.ok) {
            console.error('AuthProvider: API call to /api/users failed:', response.status, await response.text());
          } else {
             console.log('AuthProvider: User profile creation/check API call successful.');
             // Optionally: manually call fetchUserProfile here if immediate profile needed
             // const profile = await fetchUserProfile(signUpData.user.id);
             // if(isMounted) setUser(profile);
          }
        } catch (apiError) {
          console.error('AuthProvider: Error calling /api/users:', apiError);
          // Sign up in Supabase Auth might have succeeded, but DB profile failed
          return { error: apiError, data: signUpData };
        }
      } else {
         console.warn('AuthProvider: Supabase signUp did not return a user object.');
      }
      // Final state update will be handled by onAuthStateChange if auto-confirm is on,
      // or after user clicks confirmation link.
      return { data: signUpData, error: signUpError };

    } catch (err) {
      console.error('AuthProvider: Unexpected error during sign up:', err);
      return { error: err, data: null };
    }
  };

  const signOut = async () => {
    console.log('AuthProvider: Signing out...');
    try {
      const { error } = await supabaseClient.auth.signOut();
      if (error) {
        console.error('AuthProvider: Error signing out:', error);
      }
      // State updates (user/session to null) and redirect are handled by onAuthStateChange
      // No need to manually push router here if listener works correctly
    } catch (err) {
      console.error('AuthProvider: Unexpected error during sign out:', err);
    }
  };

  // Context value passed down
  const value = {
    user, // This user is now of type UserProfile | null
    session,
    isLoading,
    signIn,
    signUp,
    signOut,
  };

  // Render children only when initial loading is done
  return (
    <AuthContext.Provider value={value}>
      {!isLoading ? children : <div>Loading Authentication...</div> /* Or a proper loading spinner */}
    </AuthContext.Provider>
  );
}

// Custom hook to use the context
export const useAuth = () => {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};


// // src/context/AuthContext.tsx
// 'use client';

// import React, { createContext, useContext, useEffect, useState, ReactNode } from 'react';
// import { supabaseClient } from '@/lib/supabase'; // Ensure this path is correct
// import { useRouter } from 'next/navigation';
// import { Session, User, AuthChangeEvent, AuthSession } from '@supabase/supabase-js';

// // Define the shape of the context
// type AuthContextType = {
//   user: User | null;
//   session: Session | null;
//   isLoading: boolean;
//   signIn: (email: string, password: string) => Promise<{ error: any }>;
//   signUp: (email: string, password: string, name: string) => Promise<{ error: any, data: any }>;
//   signOut: () => Promise<void>;
// };

// // Create the context
// const AuthContext = createContext<AuthContextType | undefined>(undefined);

// interface AuthProviderProps {
//   children: ReactNode;
// }

// export function AuthProvider({ children }: AuthProviderProps) {
//   const [user, setUser] = useState<User | null>(null);
//   const [session, setSession] = useState<Session | null>(null);
//   const [isLoading, setIsLoading] = useState(true); // Start in loading state
//   const router = useRouter();

//   useEffect(() => {
//     let isMounted = true; // Flag to prevent state updates if component unmounts

//     // Function to get the current session and update state
//     const getSessionAndSetState = async () => {
//       try {
//         console.log('AuthProvider: Getting session...');
//         // Use getSession which reads from storage - fast
//         const { data: { session: currentSession }, error } = await supabaseClient.auth.getSession();

//         if (error) {
//           console.error('AuthProvider: Error getting session:', error.message);
//         }

//         if (isMounted) {
//           if (currentSession) {
//             console.log('AuthProvider: Session found, user ID:', currentSession.user.id);
//           } else {
//             console.log('AuthProvider: No active session found.');
//           }
//           setSession(currentSession);
//           setUser(currentSession?.user ?? null);
//         }
//       } catch (err) {
//         console.error('AuthProvider: Unexpected error in getSessionAndSetState:', err);
//       } finally {
//         // Only set loading to false once after initial check if component is still mounted
//         if (isMounted) {
//           setIsLoading(false);
//         }
//       }
//     };

//     // Fetch initial session state
//     getSessionAndSetState();

//     // Set up the listener for auth state changes
//     const { data: { subscription } } = supabaseClient.auth.onAuthStateChange(
//       (_event: AuthChangeEvent, session: AuthSession | null) => {
//         console.log('AuthProvider: Auth state changed:', _event);
//         if (session) {
//           console.log('AuthProvider: New session state, user ID:', session.user.id);
//         } else {
//           console.log('AuthProvider: Session is now null (signed out or expired).');
//         }
//         // Update state based on the event
//         if (isMounted) {
//           setSession(session);
//           setUser(session?.user ?? null);
//           // Keep loading false after initial load, unless a specific event requires it
//           setIsLoading(false);

//           // Redirect on SIGNED_OUT event
//           if (_event === 'SIGNED_OUT') {
//              router.push('/login'); // Redirect after state is updated
//           }
//         }
//       }
//     );

//     // Cleanup function
//     return () => {
//       isMounted = false; // Mark as unmounted
//       subscription?.unsubscribe(); // Unsubscribe the listener
//     };
//   }, [router]); // Add router to dependency array as it's used in the listener callback effect indirectly

//   // Sign In function
//   const signIn = async (email: string, password: string) => {
//     console.log('AuthProvider: Signing in with email:', email);
//     setIsLoading(true);
//     try {
//       // signInWithPassword will trigger onAuthStateChange on success
//       const { error } = await supabaseClient.auth.signInWithPassword({
//         email,
//         password
//       });

//       if (error) {
//         console.error('AuthProvider: Sign in error:', error);
//         setIsLoading(false); // Stop loading on error
//       } else {
//         console.log('AuthProvider: Sign in initiated. Waiting for auth state change...');
//         // Don't need to manually setSession/setUser here, onAuthStateChange handles it
//       }
//       return { error };
//     } catch (err) {
//       console.error('AuthProvider: Unexpected error during sign in:', err);
//       setIsLoading(false);
//       return { error: err };
//     }
//   };

//   // Sign Up function - includes API call to your backend
//   const signUp = async (email: string, password: string, name: string) => {
//     setIsLoading(true);
//     try {
//       console.log('AuthProvider: Signing up with email:', email);
//       // signUp will trigger onAuthStateChange if email confirmation is not required,
//       // otherwise user stays logged out until confirmed.
//       const { data: signUpData, error: signUpError } = await supabaseClient.auth.signUp({
//         email,
//         password,
//         options: {
//           data: { name }, // Include name in Supabase metadata if desired
//           emailRedirectTo: `${window.location.origin}/auth/callback`, // For email confirmation flow
//         }
//       });

//       if (signUpError) {
//         console.error('AuthProvider: Sign up error:', signUpError);
//         setIsLoading(false);
//         return { data: null, error: signUpError };
//       }

//       // Important: If email confirmation is required, signUpData.user might exist but session will be null.
//       // User is not truly "logged in" until confirmation.
//       // Your API call should likely happen regardless of confirmation status to create the profile.
//       if (signUpData.user) {
//         console.log('AuthProvider: Supabase Auth user created/exists. Creating user profile via API...');
//         try {
//           // Call your API route to create the corresponding user profile in your DB
//           const response = await fetch('/api/users', {
//             method: 'POST',
//             headers: { 'Content-Type': 'application/json' },
//             body: JSON.stringify({ id: signUpData.user.id, email, name }),
//           });

//           if (!response.ok) {
//             const errorBody = await response.text();
//             console.error('AuthProvider: API call to /api/users failed:', response.status, errorBody);
//             // Decide how to handle this - maybe return a specific error?
//             // For now, we'll let the original signUp success/error be the primary result.
//             // Optionally: throw new Error('Failed to create user profile record.');
//           } else {
//              console.log('AuthProvider: User profile creation API call successful.');
//           }
//         } catch (apiError) {
//           console.error('AuthProvider: Error calling /api/users:', apiError);
//           // Return the API error, but sign up itself might have succeeded in Supabase Auth
//           setIsLoading(false); // Stop loading on API error
//           return { error: apiError, data: signUpData };
//         }
//       } else {
//          // This case might occur if Supabase is configured to prevent sign-ups somehow
//          console.warn('AuthProvider: Supabase signUp did not return a user object, though no error was reported.');
//       }

//       // If email confirmation is required, user/session state won't change yet.
//       // If auto-confirm is on, onAuthStateChange will handle the login state.
//       setIsLoading(false); // Stop loading after sign up process completes
//       return { data: signUpData, error: signUpError };

//     } catch (err) {
//       console.error('AuthProvider: Unexpected error during sign up:', err);
//       setIsLoading(false);
//       return { error: err, data: null };
//     }
//   };

//   // Sign Out function
//   const signOut = async () => {
//     console.log('AuthProvider: Signing out...');
//     setIsLoading(true); // Optionally indicate loading during sign out
//     try {
//       const { error } = await supabaseClient.auth.signOut();
//       if (error) {
//         console.error('AuthProvider: Error signing out:', error);
//         setIsLoading(false); // Stop loading on error
//       }
//       // State updates (user/session to null) and redirect are now handled by the
//       // onAuthStateChange listener when it receives the 'SIGNED_OUT' event.
//     } catch (err) {
//       console.error('AuthProvider: Unexpected error during sign out:', err);
//       setIsLoading(false);
//     }
//   };

//   // Context value passed down
//   const value = {
//     user,
//     session,
//     isLoading,
//     signIn,
//     signUp,
//     signOut,
//   };

//   // Render children only when initial loading is done
//   return (
//     <AuthContext.Provider value={value}>
//       {!isLoading ? children : null /* Or a loading spinner */}
//     </AuthContext.Provider>
//   );
// }

// // Custom hook to use the context
// export const useAuth = () => {
//   const context = useContext(AuthContext);
//   if (context === undefined) {
//     // This error is correct and helps identify components rendered outside the provider
//     throw new Error('useAuth must be used within an AuthProvider');
//   }
//   return context;
// };
```

